# Anti-Abuse / Security Implementation Summary

## Огляд

Реалізовано комплексну систему захисту від зловживань та нестабільної поведінки користувачів у Telegram боті Вольтик.

## Реалізовані компоненти

### 1. Core Anti-Abuse Module (`src/utils/antiAbuse.js`)

#### UserRateLimiter
- Обмежує частоту дій користувача
- Окремі ліміти для команд, кнопок та тексту
- Конфігурація:
  - **Команди**: максимум 5 дій за 10 секунд, cooldown 3 секунди
  - **Кнопки**: максимум 10 натискань за 10 секунд, cooldown 2 секунди
  - **Текст**: максимум 5 повідомлень за 10 секунд, cooldown 2 секунди
- Автоматична очистка старих записів кожні 5 хвилин

#### ActionCooldownManager
- Управління cooldown для критичних дій
- Cooldown налаштування:
  - **channel_connect**: 60 секунд
  - **channel_disconnect**: 30 секунд
  - **ip_change**: 30 секунд
  - **wizard_start**: 30 секунд
  - **confirm_setup**: 5 секунд
- Автоматична очистка старих записів кожні 10 хвилин

#### StateConflictManager
- Забезпечує що користувач має тільки ОДИН активний flow
- Підтримувані flow: wizard, ip_setup, channel_setup
- Блокує спроби запустити кілька процесів одночасно

#### IpValidator
- Валідація IP адрес
- Блокує:
  - localhost (127.0.0.1, ::1)
  - Приватні IP (192.168.*, 10.*, 172.16-31.*)
- Дозволяє публічні IP та DDNS домени

#### ActionLogger
- Централізоване логування подій безпеки
- Логує:
  - Спрацьовування rate limit
  - Спрацьовування cooldown
  - Конфлікти state
  - Спроби використання заборонених IP
  - Системні помилки

### 2. Anti-Abuse Middleware (`src/middleware/antiAbuseMiddleware.js`)

Надає зручні функції-обгортки для швидкої інтеграції:
- `checkRateLimit()` - перевірка rate limit
- `checkCooldown()` - перевірка cooldown
- `checkStateConflict()` - перевірка конфліктів state
- `getPluralForm()` - правильне відмінювання українською

### 3. Інтеграція в Handlers

#### bot.js
- ✅ Rate limiting для всіх команд через wrapper `withRateLimit()`
- ✅ Rate limiting для callback queries (кнопки)
- ✅ Rate limiting для текстових повідомлень

#### handlers/start.js (Wizard)
- ✅ Cooldown для запуску wizard (30 секунд)
- ✅ Перевірка на pause mode
- ✅ State conflict detection
- ✅ Automatic state cleanup на завершення

#### handlers/settings.js (IP Setup)
- ✅ Валідація IP через IpValidator
- ✅ Блокування localhost та приватних IP
- ✅ Cooldown для зміни IP (30 секунд)
- ✅ State conflict detection
- ✅ Automatic state cleanup

#### handlers/channel.js (Channel Setup)
- ✅ Cooldown для підключення каналу (60 секунд)
- ✅ State conflict detection
- ✅ Automatic state cleanup

## UX Принципи

### Повідомлення користувачу завжди:
- ✅ Зрозумілі та ввічливі
- ✅ Вказують час очікування в секундах
- ✅ Не виглядають як покарання
- ✅ Не спамлять (особливо для тексту)

### Приклади повідомлень:
```
⏳ Зачекайте 3 секунди і спробуйте ще раз.
⏱ Цю дію можна виконувати не так часто. Спробуйте через 25 секунд.
⚠️ Спочатку завершіть налаштування IP. Ви не можете мати кілька активних дій одночасно.
❌ Приватні IP (192.168.*) не підтримуються. Введіть публічну IP-адресу або DDNS.
```

## Логування

Всі події безпеки логуються в консоль:
```
[RATE_LIMIT] User 123456 | Action: button | Wait: 2s
[COOLDOWN] User 123456 | Action: wizard_start | Remaining: 15s
[STATE_CONFLICT] User 123456 | Attempted: ip_setup | Current: wizard
[FORBIDDEN_IP] User 123456 | IP: 192.168.1.1 | Reason: private_ip_forbidden
```

## Тестування

Створено тестовий файл `test-anti-abuse.js` для перевірки всіх компонентів:
- ✅ UserRateLimiter
- ✅ ActionCooldownManager
- ✅ StateConflictManager
- ✅ IpValidator

Запуск: `node test-anti-abuse.js`

## Fail-Safe Поведінка

Система розроблена з принципом "fail-safe":
- Помилки не ламають роботу бота
- Всі timeout-и та інтервали очищаються при видаленні state
- Автоматична очистка старих записів запобігає витоку памʼяті
- Захист працює навіть якщо один компонент не спрацював

## Definition of Done

✅ Бот не падає від частих дій
✅ Немає спаму повідомлень
✅ State не плутається (один активний flow)
✅ IP і канали не зловживаються
✅ UX залишається зрозумілим
✅ Система передбачувана
✅ Логи доступні для аналізу

## Майбутні покращення

Можливі напрямки розвитку:
1. Збереження статистики зловживань в БД
2. Автоматичне блокування користувачів при систематичних порушеннях
3. Адаптивні ліміти на основі навантаження
4. Dashboard для моніторингу безпеки
5. Сповіщення адміністраторів про підозрілу активність

## Технічні деталі

### Архітектура
- Модульна структура з чіткими обовʼязками
- Глобальні інстанси для збереження стану між запитами
- Мінімальна залежність від інших модулів
- Легка інтеграція в існуючий код

### Продуктивність
- O(n) складність для перевірок де n - кількість дій користувача
- Автоматична очистка запобігає витоку памʼяті
- Мінімальне навантаження на БД (тільки для persistence state)

### Безпека
- Валідація на рівні модуля
- Захист від race conditions через синхронні перевірки
- Логування всіх подій для аудиту
